# Soft Mesh Mapping - 软网格映射演示

一个交互式的网格变形演示程序，通过鼠标拖拽实时变形图像。基于物理模拟的弹簧质点模型，展示了网格映射和纹理变换的图形学技术。

**本项目基于 [EGE_Net](https://github.com/wysaid/EGE_Net) 项目扩展而来，在其网格物理模拟的基础上增加了纹理映射和图像变形功能。**

## 功能特性

- 📌 实时交互式网格变形：鼠标拖拽网格节点，图像随之变形
- 🔧 可调节的弹性强度：通过 `+` / `-` 键调整网格的弹力系数
- 🎨 支持多种图片格式：JPG、PNG、BMP、GIF
- 🖼️ 流畅的视觉效果：基于三角形网格的高效渲染和纹理映射

## 算法原理

### 1. 网格结构初始化

程序将图像空间划分为 $m \times n$ 的网格点阵（默认配置为 80×60）。每个网格点存储：

- **位置坐标** $(x, y)$：归一化到 $[0, 1]$ 区间
- **速度分量** $(v_x, v_y)$：用于物理模拟
- **纹理坐标** $(u, v)$：对应原始图像中的采样位置

四边形网格被划分为三角形对，每个四边形由两个共享对角线的三角形组成，便于后续的纹理映射。

### 2. 弹簧质点物理模拟

#### 弹性力计算

对于每个内部网格点 $P_i$，计算其受到的四个方向（上下左右）相邻点的弹力：

$$F_i = k \sum_{j \in \text{neighbors}} (P_j - P_i)$$

其中：

- $k$ 是弹性系数（可通过键盘实时调节）
- $P_j - P_i$ 是点之间的位移向量
- 相邻点包括上下左右四个方向的网格点

#### 能量耗散机制

为了模拟现实中的阻尼效果，当加速度方向与速度方向相反时（即网格正在回弹），程序会增强阻尼效果：

```cpp
if (sign(acceleration) != sign(velocity))
    acceleration *= (1.0 + intensity)
```

这种非对称阻尼使得网格变形后能够快速稳定下来，避免过度震荡。

#### 数值积分（显式欧拉法）

使用显式欧拉方法更新速度和位置：

$$v_i^{\text{new}} = v_i^{\text{old}} + a_i \cdot k$$

$$x_i^{\text{new}} = x_i^{\text{old}} + v_i^{\text{new}}$$

其中 $k$ 为弹性强度参数，同时充当时间步长和劲度系数的复合因子。

#### 边界条件

- **边界点固定**：网格四周的边界点位置固定，不参与物理模拟
- **用户交互**：鼠标按下时，找到距离最近的内部点并固定到鼠标位置，速度清零

### 3. 三角形纹理映射

#### 扫描线填充算法

对于每个三角形，使用扫描线算法逐行填充：

1. **三角形分类**：
   - 平底三角形（两个点在同一水平线）
   - 平顶三角形（顶点在上方或下方）
   - 普通三角形（三个点高度各不相同）

2. **普通三角形分割**：
   - 通过中间点高度将普通三角形分割为一个平底和一个平顶三角形
   - 分割点的纹理坐标通过线性插值计算：
   
   $$P_{\text{split}} = P_{\text{top}} + \frac{y_{\text{mid}} - y_{\text{top}}}{y_{\text{bottom}} - y_{\text{top}}} (P_{\text{bottom}} - P_{\text{top}})$$

3. **扫描线渲染**：
   - 对于每一条扫描线，计算左右边界的 $x$ 坐标和对应的纹理坐标 $(u, v)$
   - 在扫描线内部，通过线性插值计算每个像素的纹理坐标
   - 从原始图像中采样对应位置的颜色值

#### 纹理坐标插值

在三角形内部，纹理坐标的插值分两步进行：

1. **垂直方向插值**（沿三角形边）：
   $$u_{\text{edge}} = u_{\text{start}} + \Delta u \cdot \frac{y - y_{\text{start}}}{y_{\text{end}} - y_{\text{start}}}$$

2. **水平方向插值**（沿扫描线）：
   $$u_{\text{pixel}} = u_{\text{left}} + (u_{\text{right}} - u_{\text{left}}) \cdot \frac{x - x_{\text{left}}}{x_{\text{right}} - x_{\text{left}}}$$

这种双线性插值保证了纹理映射的连续性和平滑性。

### 4. 性能优化

1. **双缓冲机制**：使用两个缓冲区交替存储当前帧和下一帧的网格状态，避免读写冲突
2. **边界点跳过**：边界点直接跳过物理计算，减少约 30% 的计算量
3. **最近点缓存**：鼠标拖拽时缓存最近的网格点索引，避免重复搜索
4. **整数坐标优化**：在最终渲染前将浮点坐标转换为整数，提高像素访问效率

## 代码结构

### 核心类与数据结构

**`Point` 结构体**：存储单个网格点的完整状态

```cpp
struct Point {
    float x, y;      // 当前位置（归一化坐标）
    float dx, dy;    // 速度分量
    float u, v;      // 纹理坐标
};
```

**`Net` 类**：网格管理和渲染的核心类

- `initNet(w, h, texture, target)`：初始化网格结构和纹理
- `update()`：执行一帧物理模拟，更新所有内部点的位置和速度
- `drawNet()`：渲染变形后的纹理到目标图像
- `catchPoint(x, y)`：处理鼠标按下，固定最近的网格点
- `releasePoint()`：释放被固定的网格点
- `fillTriangle(v0, v1, v2)`：填充单个三角形并进行纹理映射

### 关键算法函数

**`_fillSimpleTriangle()`**：填充平底或平顶三角形

- 沿三角形边界计算纹理坐标的增量
- 逐行扫描并插值纹理坐标
- 从原始纹理中采样并写入目标缓冲区

**`_fillNormalTriangle()`**：处理普通三角形

- 按 $y$ 坐标对三个顶点排序
- 计算中间分割点的位置和纹理坐标
- 将三角形分割为两个简单三角形分别填充

## 学习价值

本项目展示了多个计算机图形学和物理模拟的核心概念：

### 图形学技术

- **扫描线光栅化**：经典的三角形填充算法实现
- **纹理映射**：双线性插值的纹理坐标计算
- **几何变换**：从世界坐标到屏幕坐标的转换
- **三角形网格**：四边形网格的三角剖分方法

### 物理模拟

- **弹簧质点系统**：简化的软体物理模拟
- **数值积分**：显式欧拉法的应用与局限
- **阻尼与稳定性**：非对称阻尼的稳定性优化技巧
- **边界条件**：固定边界对系统稳定性的影响

### 性能优化

- **内存布局**：缓存友好的数据结构设计
- **计算剪枝**：跳过不必要的边界点计算
- **索引缓存**：避免重复的空间查询
- **坐标转换**：在合适的时机进行浮点到整数的转换

## 与 EGE_Net 的对比

本项目在 [EGE_Net](https://github.com/wysaid/EGE_Net) 的基础上做了以下扩展：

| 特性 | EGE_Net | Soft Mesh Mapping |
|------|---------|-------------------|
| 网格物理模拟 | ✅ | ✅ |
| 网格线框显示 | ✅ | ✅（仅拖拽时） |
| 纹理映射 | ❌ | ✅ |
| 图像变形 | ❌ | ✅ |
| 三角形光栅化 | ❌ | ✅ |
| 扫描线填充 | ❌ | ✅ |

**主要区别**：

- **EGE_Net** 专注于展示弹簧质点系统的物理模拟效果，通过绘制网格线框直观展示网格的变形
- **Soft Mesh Mapping** 在此基础上实现了完整的图像纹理映射，将网格变形应用到真实图像上，实现了类似 Photoshop 液化工具的效果

## 快速开始

### 构建项目

```bash
mkdir build
cd build
cmake ..
cmake --build . --config Release
```

### 运行程序

编译完成后，可执行文件在 `build/Release/` 目录下。

**操作方式**：

- 鼠标左键拖拽：变形网格
- `+` 键：增大弹性强度
- `-` 键：减小弹性强度
- `ESC` 键：退出程序

## 依赖

本项目使用 [EGE (Easy Graphics Engine)](https://github.com/x-ege/xege) 图形库。必要的头文件和库文件已包含在 `ege/` 目录中，支持多个编译器版本（MSVC、MinGW-w64 等）。
